<div class="fixed inset-0 backdrop-blur-sm z-50 flex items-center justify-center p-4"
     *ngIf="isOpen()"
     (click)="onClose()">
  <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-2xl transform transition-all duration-300 scale-100"
       (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50">
      <h2 class="text-2xl font-bold text-gray-800">{{ modalTitle() }}</h2>
      <button class="p-2 text-gray-600 hover:text-gray-800 hover:bg-white rounded-full transition-all duration-200 hover:scale-110"
              (click)="onClose()"
              title="Cerrar">
        ✕
      </button>
    </div>

    <!-- Content -->
    <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
      <form [formGroup]="mensajeForm()" class="space-y-6">
        <!-- Remitente y Destinatario -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label for="remitenteId" class="block text-sm font-medium text-gray-700 mb-2">
              Remitente *
            </label>
            <select
              id="remitenteId"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
              formControlName="remitenteId"
              [class.border-red-500]="mensajeForm().get('remitenteId')?.invalid && mensajeForm().get('remitenteId')?.touched"
            >
              <option value="">Seleccionar remitente</option>
              <option *ngFor="let user of usuarios()" [value]="user.uid">
                {{ user.nombre || user.email || user.uid }} ({{ user.role }})
              </option>
            </select>
            @if (mensajeForm().get('remitenteId')?.invalid && mensajeForm().get('remitenteId')?.touched) {
              <p class="mt-1 text-sm text-red-600">
                El remitente es obligatorio
              </p>
            }
          </div>

          <div class="form-group">
            <label for="destinatarioId" class="block text-sm font-medium text-gray-700 mb-2">
              Destinatario *
            </label>
            <select
              id="destinatarioId"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
              formControlName="destinatarioId"
              [class.border-red-500]="mensajeForm().get('destinatarioId')?.invalid && mensajeForm().get('destinatarioId')?.touched"
            >
              <option value="">Seleccionar destinatario</option>
              <option *ngFor="let user of usuarios()" [value]="user.uid">
                {{ user.nombre || user.email || user.uid }} ({{ user.role }})
              </option>
            </select>
            @if (mensajeForm().get('destinatarioId')?.invalid && mensajeForm().get('destinatarioId')?.touched) {
              <p class="mt-1 text-sm text-red-600">
                El destinatario es obligatorio
              </p>
            }
          </div>
        </div>

        <!-- Tipo de Mensaje -->
        <div class="form-group">
          <label for="tipo" class="block text-sm font-medium text-gray-700 mb-2">
            Tipo de Mensaje *
          </label>
          <select
            id="tipo"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
            formControlName="tipo"
            [class.border-red-500]="mensajeForm().get('tipo')?.invalid && mensajeForm().get('tipo')?.touched"
          >
            <option value="texto">Texto</option>
            <option value="imagen">Imagen</option>
            <option value="video">Video</option>
            <option value="audio">Audio</option>
          </select>
          @if (mensajeForm().get('tipo')?.invalid && mensajeForm().get('tipo')?.touched) {
            <p class="mt-1 text-sm text-red-600">
              El tipo de mensaje es obligatorio
            </p>
          }
        </div>

        <!-- Contenido -->
        <div class="form-group">
          <label for="contenido" class="block text-sm font-medium text-gray-700 mb-2">
            Contenido *
          </label>
          <textarea
            id="contenido"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none"
            formControlName="contenido"
            placeholder="Escribe el mensaje aquí..."
            rows="6"
            [class.border-red-500]="mensajeForm().get('contenido')?.invalid && mensajeForm().get('contenido')?.touched"
          ></textarea>
          @if (mensajeForm().get('contenido')?.invalid && mensajeForm().get('contenido')?.touched) {
            <p class="mt-1 text-sm text-red-600">
              El contenido es obligatorio
            </p>
          }
        </div>
      </form>
    </div>

    <!-- Footer -->
    <div class="flex items-center justify-end space-x-3 p-6 border-t border-gray-200 bg-gray-50">
      <button
        type="button"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200"
        (click)="onClose()"
        [disabled]="isLoading()"
      >
        Cancelar
      </button>
      <button
        type="button"
        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
        (click)="onSaveMensaje()"
        [disabled]="isLoading() || mensajeForm().invalid"
      >
        @if (isLoading()) {
          <span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
          Guardando...
        } @else {
          {{ isCreating() ? 'Enviar Mensaje' : 'Actualizar Mensaje' }}
        }
      </button>
    </div>
  </div>
</div>