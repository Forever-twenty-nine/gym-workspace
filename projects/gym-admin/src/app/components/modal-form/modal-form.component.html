@if (isOpen) {
<!-- Overlay -->
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4 backdrop-blur-md" (click)="onOverlayClick()">
  <!-- Modal Content -->
  <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden shadow-2xl transform transition-all duration-300 scale-100"
    (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-linear-to-r from-blue-50 to-purple-50">
      <h2 class="text-xl font-bold text-gray-800">
        @if (isCreating) {
          Crear {{ title }}
        } @else {
          Editar {{ title }}
        }
      </h2>
      <button class="p-2 text-gray-600 hover:text-gray-800 hover:bg-white rounded-full transition-all duration-200 hover:scale-110" (click)="onClose()"
        title="Cerrar">
        ✕
      </button>
    </div>

    <!-- Content -->
    <div class="p-6 overflow-y-auto max-h-[70vh] bg-gray-50">
      @if (form) {
      <form [formGroup]="form" class="space-y-6">

        <!-- Formulario Dinámico -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          @for (field of formFields; track field.name) {
          <!-- Campo dinámico -->
          <div [ngClass]="field.colSpan === 2 ? 'col-span-2' : 'col-span-1'">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              {{ field.label }}
            </label>

            @switch (field.type) {
              <!-- Input de texto -->
              @case ('text') {
                <input [type]="field.inputType || 'text'" [formControlName]="field.name"
                  [placeholder]="field.placeholder || ''" [readonly]="field.readonly || false"
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-white hover:border-gray-400"
                  [class.border-red-300]="form.get(field.name)?.invalid && form.get(field.name)?.touched"
                  [class.focus:ring-red-500]="form.get(field.name)?.invalid && form.get(field.name)?.touched"
                  [class.bg-gray-100]="field.readonly"
                  [class.text-gray-600]="field.readonly">

                <!-- Mensaje de error -->
                @if (form.get(field.name)?.invalid && form.get(field.name)?.touched) {
                  <p class="mt-1 text-xs text-red-600">
                    @if (form.get(field.name)?.errors?.['required']) {
                      Este campo es obligatorio
                    }
                  </p>
                }
              }

              <!-- Textarea -->
              @case ('textarea') {
                <textarea [formControlName]="field.name" [placeholder]="field.placeholder || ''" [rows]="3"
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-white hover:border-gray-400 resize-none"></textarea>
              }

              <!-- Select -->
              @case ('select') {
                <select [formControlName]="field.name"
                  class="w-full px-4 py-3 border text-black border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-white hover:border-gray-400"
                  [class.border-red-300]="form.get(field.name)?.invalid && form.get(field.name)?.touched"
                  [class.focus:ring-red-500]="form.get(field.name)?.invalid && form.get(field.name)?.touched">
                  <option value="">{{ field.placeholder }}</option>
                  @for (option of field.options || []; track option.value) {
                    <option [value]="option.value">{{ option.label }}</option>
                  }
                </select>

                <!-- Mensaje de error -->
                @if (form.get(field.name)?.invalid && form.get(field.name)?.touched) {
                  <p class="mt-1 text-xs text-red-600">
                    @if (form.get(field.name)?.errors?.['required']) {
                      Debes seleccionar una opción
                    }
                  </p>
                }
              }

              <!-- Checkbox -->
              @case ('checkbox') {
                <label class="flex items-center p-3 bg-white rounded-xl border border-gray-200 hover:border-gray-300 transition-all duration-200 cursor-pointer">
                  <input type="checkbox" [formControlName]="field.name"
                    class="mr-3 h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded-md">
                  <span class="text-sm font-semibold text-gray-700">{{ field.checkboxLabel }}</span>
                </label>
              }
            }
          </div>
          }
        </div>
      </form>
      }
    </div>

    <!-- Footer -->
    <div class="flex items-center justify-end gap-4 p-6 border-t border-gray-200 bg-white">
        <button type="button" (click)="onClose()"
          class="px-6 py-3 text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-300 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200 hover:scale-105">
          Cancelar
        </button>

        <button type="button" (click)="onSave()" [disabled]="!form?.valid || isLoading"
          class="px-6 py-3 text-sm font-semibold text-white bg-blue-600 border border-transparent rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 hover:scale-105 disabled:hover:scale-100">
          @if (isLoading) {
          <span class="flex items-center">
            <svg class="w-5 h-5 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
              </path>
            </svg>
            Guardando...
          </span>
          } @else {
          Guardar Cambios
          }
        </button>
    </div>
  </div>
</div>
}
