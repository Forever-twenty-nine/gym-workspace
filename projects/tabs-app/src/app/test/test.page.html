<div class="p-4 space-y-6">

    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-white">Test de servicios</h1>   
    </div>

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Usuarios -->
        <div class="p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
            <h2 class="font-semibold text-gray-700 mb-3">Usuarios</h2>
            <div class="space-y-3">
                <button 
                    class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors"
                    (click)="addSampleUsuario()">
                    Crear usuario
                </button>             
                <!-- Lista de usuarios -->
                <div class="border rounded-lg bg-gray-50 max-h-80 overflow-y-auto">
                    @for(item of usuarios(); track item.uid) {
                        <div class="px-3 py-2 border-b border-gray-100 last:border-b-0 hover:bg-gray-50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-medium text-gray-800">{{ item.nombre }}</h4>
                                    <p class="text-sm text-gray-600">Rol: {{ item.role }}</p>
                                </div>
                                <div class="flex gap-1">
                                    <button 
                                        class="p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded"
                                        (click)="openDetailsModal(item, 'usuario')"
                                        title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    <button 
                                        class="p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded"
                                        (click)="deleteUsuario(item.uid)"
                                        title="Eliminar">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    } @empty {
                        <div class="px-3 py-4 text-center text-gray-500">
                            <p class="text-sm">No hay usuarios creados</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Clientes -->
        <div class="p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
            <h2 class="font-semibold text-gray-700 mb-3">Clientes</h2>
            <div class="space-y-3">
                <button 
                    class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors"
                    (click)="addSampleCliente()">
                    Crear cliente
                </button>
                <!-- Lista de clientes -->
                <div class="border rounded-lg bg-gray-50 max-h-80 overflow-y-auto">
                    @for(item of clientes(); track item.id) {
                        <div class="px-3 py-2 border-b border-gray-100 last:border-b-0 hover:bg-gray-50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-medium text-gray-800">{{ item.gimnasioId }}</h4>
                                    <p class="text-sm text-gray-600">Gimnasio: {{ item.gimnasioId }} ‚Ä¢ Activo: {{ item.activo }}</p>
                                </div>
                                <div class="flex gap-1">
                                    <button 
                                        class="p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded"
                                        (click)="openDetailsModal(item, 'cliente')"
                                        title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    <button 
                                        class="p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded"
                                        (click)="deleteCliente(item.id)"
                                        title="Eliminar">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    } @empty {
                        <div class="px-3 py-4 text-center text-gray-500">
                            <p class="text-sm">No hay clientes creados</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Rutinas -->
        <div class="p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
            <h2 class="font-semibold text-gray-700 mb-3">Rutinas</h2>
            <div class="space-y-3">
                <button 
                    class="w-full px-4 py-2 text-white rounded-md transition-colors"
                    [class]="canCreateRutina() ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-400 cursor-not-allowed'"
                    [disabled]="!canCreateRutina()"
                    (click)="addSampleRutina()"
                    [title]="canCreateRutina() ? 'Crear rutina' : getRutinaValidationMessage()">
                    @if (canCreateRutina()) {
                        Crear rutina
                    } @else {
                        ‚ö†Ô∏è Sin usuarios suficientes
                    }
                </button>

                <!-- Mensaje de validaci√≥n -->
                @if (!canCreateRutina()) {
                    <div class="p-2 bg-amber-50 border border-amber-200 rounded-md">
                        <p class="text-xs text-amber-700">{{ getRutinaValidationMessage() }}</p>
                    </div>
                }
                
                <!-- Lista de rutinas -->
                <div class="border rounded-lg bg-gray-50 max-h-80 overflow-y-auto">
                    @for (item of rutinas(); track item.id) {
                        <div class="px-3 py-2 border-b border-gray-100 last:border-b-0 hover:bg-gray-50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-medium text-gray-800">{{ item.nombre }}</h4>
                                    <p class="text-sm text-gray-600">
                                        üë§ {{ getClienteName(item.clienteId || '') }}
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        üèÉ‚Äç‚ôÇÔ∏è {{ getEntrenadorName(item.entrenadorId || '') }}
                                    </p>
                                </div>
                                <div class="flex gap-1">
                                    <button 
                                        class="p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded"
                                        (click)="openDetailsModal(item, 'rutina')"
                                        title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    <button 
                                        class="p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded"
                                        (click)="deleteRutina(item.id)"
                                        title="Eliminar">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    } @empty {
                        <div class="px-3 py-4 text-center text-gray-500">
                            <p class="text-sm">No hay rutinas creadas</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Ejercicios -->
        <div class="p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
            <h2 class="font-semibold text-gray-700 mb-3">Ejercicios</h2>
            <div class="space-y-3">
                <button 
                    class="w-full px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-md transition-colors"
                    (click)="addSampleEjercicio()">
                    Crear ejercicio
                </button>
                <!-- Lista de ejercicios -->
                <div class="border rounded-lg bg-gray-50 max-h-80 overflow-y-auto">

                    @for (item of ejercicios(); track item.id) {
                        <div class="px-3 py-2 border-b border-gray-100 last:border-b-0 hover:bg-gray-50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-medium text-gray-800">{{ item.nombre }}</h4>
                                    <p class="text-sm text-gray-600">{{ item.series }}x{{ item.repeticiones }}</p>
                                </div>
                                <div class="flex gap-1">
                                    <button 
                                        class="p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded"
                                        (click)="openDetailsModal(item, 'ejercicio')"
                                        title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    <button 
                                        class="p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded"
                                        (click)="deleteEjercicio(item.id)"
                                        title="Eliminar">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    } @empty {
                        <div class="px-3 py-4 text-center text-gray-500">
                            <p class="text-sm">No hay ejercicios creados</p>
                        </div>
                    }
                </div>
                <!---->
            </div>
        </div>
    </section>

    <!-- Logs -->
    <section class="p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
        <h2 class="font-semibold text-gray-700 mb-3">Logs</h2>
        <div class="border rounded-lg bg-gray-50 max-h-72 overflow-y-auto">
            @for (log of logs(); track $index) {
                <div class="px-3 py-2 border-b border-gray-100 last:border-b-0">
                    <p class="text-sm text-gray-700">{{ log }}</p>
                </div>
            } @empty {
                <div class="px-3 py-4 text-center text-gray-500">
                    <p class="text-sm">No hay logs disponibles</p>
                </div>
            }
        </div>
    </section>

    <!-- üìù Modal de edici√≥n -->
    @if (isModalOpen()) {
        <!-- Overlay -->
        <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" (click)="closeModal()">
            <!-- Modal Content -->
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-xl" (click)="$event.stopPropagation()">
                <!-- Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">
                        @if (isCreating()) {
                            ‚ûï Crear {{ modalType() | titlecase }}
                        } @else {
                            ‚úèÔ∏è Editar {{ modalType() | titlecase }}
                        }
                    </h2>
                    <button 
                        class="p-1 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-full"
                        (click)="closeModal()"
                        title="Cerrar">
                        ‚úï
                    </button>
                </div>

                <!-- Content -->
                <div class="p-6 overflow-y-auto max-h-[70vh]">
                    @if (editForm()) {
                        <form [formGroup]="editForm()!" class="space-y-6">
                            
                            <!-- üîÑ Formulario Din√°mico con @for y @switch -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                @for (field of getFormFields(); track field.name) {
                                    <!-- Campo din√°mico con @switch -->
                                    <div [ngClass]="field.colSpan === 2 ? 'col-span-2' : 'col-span-1'">>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            {{ field.icon }} {{ field.label }}
                                        </label>

                                        @switch (field.type) {
                                            <!-- üìù Input de texto -->
                                            @case ('text') {
                                                <input
                                                    [type]="field.inputType || 'text'"
                                                    [formControlName]="field.name"
                                                    [placeholder]="field.placeholder || ''"
                                                    [min]="field.min || null"
                                                    [step]="field.step || null"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    [class.border-red-300]="editForm()?.get(field.name)?.invalid && editForm()?.get(field.name)?.touched"
                                                    [class.focus:ring-red-500]="editForm()?.get(field.name)?.invalid && editForm()?.get(field.name)?.touched">
                                                
                                                <!-- Mensaje de error -->
                                                @if (editForm()?.get(field.name)?.invalid && editForm()?.get(field.name)?.touched) {
                                                    <p class="mt-1 text-xs text-red-600">
                                                        @if (editForm()?.get(field.name)?.errors?.['required']) {
                                                            Este campo es obligatorio
                                                        }
                                                    </p>
                                                }
                                            }

                                            <!-- üìù Textarea -->
                                            @case ('textarea') {
                                                <textarea
                                                    [formControlName]="field.name"
                                                    [placeholder]="field.placeholder || ''"
                                                    [rows]="field.rows || 3"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                            }

                                            <!-- üìã Select -->
                                            @case ('select') {
                                                <select
                                                    [formControlName]="field.name"
                                                    class="w-full px-3 py-2 border text-black border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    [class.border-red-300]="editForm()?.get(field.name)?.invalid && editForm()?.get(field.name)?.touched"
                                                    [class.focus:ring-red-500]="editForm()?.get(field.name)?.invalid && editForm()?.get(field.name)?.touched">
                                                    <option value="">{{ field.placeholder }}</option>
                                                    @for (option of field.options || []; track option.value) {
                                                        <option [value]="option.value">{{ option.label }}</option>
                                                    }
                                                </select>
                                                
                                                <!-- Mensaje de error -->
                                                @if (editForm()?.get(field.name)?.invalid && editForm()?.get(field.name)?.touched) {
                                                    <p class="mt-1 text-xs text-red-600">
                                                        @if (editForm()?.get(field.name)?.errors?.['required']) {
                                                            Debes seleccionar una opci√≥n
                                                        }
                                                    </p>
                                                }
                                            }

                                            <!-- ‚úÖ Checkbox -->
                                            @case ('checkbox') {
                                                <label class="flex items-center">
                                                    <input
                                                        type="checkbox"
                                                        [formControlName]="field.name"
                                                        class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                                    <span class="text-sm font-medium text-gray-700">{{ field.checkboxLabel }}</span>
                                                </label>
                                            }

                                            <!-- üìÖ D√≠as de la semana (solo para rutinas) -->
                                            @case ('dias-semana') {
                                                <div class="grid grid-cols-3 md:grid-cols-7 gap-2">
                                                    @for (dia of getDiasSemanOptions(); track dia.value) {
                                                        <label class="flex items-center text-sm">
                                                            <input
                                                                type="checkbox"
                                                                [checked]="editForm()?.get('DiasSemana')?.value?.includes(dia.value)"
                                                                (change)="toggleDiaSemana($event, dia.value)"
                                                                class="mr-1 h-3 w-3 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                                            <span class="text-xs">{{ dia.label.slice(0, 3) }}</span>
                                                        </label>
                                                    }
                                                </div>
                                            }

                                            <!-- üèãÔ∏è Selecci√≥n de ejercicios (solo para rutinas) -->
                                            @case ('ejercicios-selector') {
                                                <!-- Lista de ejercicios disponibles -->
                                                <div class="border border-gray-300 rounded-md max-h-60 overflow-y-auto bg-gray-50">
                                                    @if (ejercicios().length > 0) {
                                                        @for (ejercicio of ejercicios(); track ejercicio.id) {
                                                            <label class="flex items-center p-3 hover:bg-gray-100 border-b border-gray-200 last:border-b-0 cursor-pointer">
                                                                <input
                                                                    type="checkbox"
                                                                    [checked]="isEjercicioSelected(ejercicio.id)"
                                                                    (change)="toggleEjercicio(ejercicio.id)"
                                                                    class="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                                                
                                                                <div class="flex-1">
                                                                    <div class="flex justify-between items-center">
                                                                        <h4 class="font-medium text-gray-800">{{ ejercicio.nombre }}</h4>
                                                                        <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded">
                                                                            {{ ejercicio.series }}x{{ ejercicio.repeticiones }}
                                                                        </span>
                                                                    </div>
                                                                    <p class="text-sm text-gray-600 mt-1">
                                                                        @if (ejercicio.peso && ejercicio.peso > 0) {
                                                                            <span>{{ ejercicio.peso }}kg ‚Ä¢ </span>
                                                                        }
                                                                        @if (ejercicio.serieSegundos && ejercicio.serieSegundos > 0) {
                                                                            <span>{{ ejercicio.serieSegundos }}s ‚Ä¢ </span>
                                                                        }
                                                                        @if (ejercicio.descansoSegundos) {
                                                                            <span>Descanso: {{ ejercicio.descansoSegundos }}s</span>
                                                                        }
                                                                    </p>
                                                                </div>
                                                            </label>
                                                        }
                                                    } @else {
                                                        <div class="p-4 text-center text-gray-500">
                                                            <p class="text-sm">No hay ejercicios disponibles</p>
                                                            <p class="text-xs text-gray-400 mt-1">Crea algunos ejercicios primero</p>
                                                        </div>
                                                    }
                                                </div>

                                                <!-- Resumen de ejercicios seleccionados -->
                                                @if (selectedEjercicios().length > 0) {
                                                    <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-md">
                                                        <h4 class="text-sm font-medium text-blue-800 mb-2">üìã Ejercicios seleccionados:</h4>
                                                        <div class="flex flex-wrap gap-2">
                                                            @for (ejercicioId of selectedEjercicios(); track ejercicioId) {
                                                                @if (getEjercicioById(ejercicioId); as ejercicio) {
                                                                    <span class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                                                        {{ ejercicio.nombre }}
                                                                        <button
                                                                            type="button"
                                                                            (click)="toggleEjercicio(ejercicioId)"
                                                                            class="ml-1 text-blue-600 hover:text-blue-800 focus:outline-none">
                                                                            ‚úï
                                                                        </button>
                                                                    </span>
                                                                }
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                            }

                                            <!-- üèãÔ∏è Estados de rutina (checkboxes m√∫ltiples) -->
                                            @case ('rutina-estados') {
                                                <div class="space-y-3">
                                                    <label class="flex items-center">
                                                        <input
                                                            type="checkbox"
                                                            formControlName="activa"
                                                            class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                                        <span class="text-sm font-medium text-gray-700">Rutina Activa</span>
                                                    </label>

                                                    <label class="flex items-center">
                                                        <input
                                                            type="checkbox"
                                                            formControlName="completado"
                                                            class="mr-2 h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                                        <span class="text-sm font-medium text-gray-700">Completado</span>
                                                    </label>
                                                </div>
                                            }
                                        }
                                    </div>
                                }
                            </div>
                        </form>
                    }
                </div>

                <!-- Footer -->
                <div class="flex items-center justify-end gap-3 p-4 border-t border-gray-200 bg-gray-50">
                    <button
                        type="button"
                        (click)="closeModal()"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        ‚ùå Cancelar
                    </button>
                    
                    <button
                        type="button"
                        (click)="saveChanges()"
                        [disabled]="!editForm()?.valid || isLoading()"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        @if (isLoading()) {
                            <span class="flex items-center">
                                <svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Guardando...
                            </span>
                        } @else {
                            üíæ Guardar Cambios
                        }
                    </button>
                </div>
            </div>
        </div>
    }
</div>