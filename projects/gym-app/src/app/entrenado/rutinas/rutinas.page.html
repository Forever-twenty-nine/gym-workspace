<ion-header [translucent]="true">
  <ion-toolbar>
    <!-- <ion-title>Rutinas</ion-title> -->
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Rutinas</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Cronómetro en pantalla completa -->
  @if (cronometroActivo()) {
    <app-cronometro-rutina
      [nombreRutina]="rutinaEnCurso()?.nombre || 'Rutina'"
      [tiempoTranscurrido]="tiempoTranscurrido()"
      [pausado]="cronometroPausado()"
      [cantidadEjercicios]="rutinaEnCurso()?.ejercicios?.length || 0"
      (pausar)="pausarCronometro()"
      (finalizar)="finalizarEntrenamiento()"
      (detener)="detenerCronometro()">
    </app-cronometro-rutina>
  }

  <div class="entrenamientos-container">
    <ion-list>
      @if (rutinasAsignadas().length === 0) {
        <ion-card>
          <ion-card-content>
            <p style="text-align: center; padding: 20px; color: var(--ion-color-medium);">
              No tienes rutinas asignadas todavía.
            </p>
          </ion-card-content>
        </ion-card>
      }
      
      @for (rutina of rutinasAsignadas(); track $index) {
        <ion-card class="rutina-card" (click)="abrirDetalles(rutina)">
          <ion-card-header>
            <div class="card-header-content">
              <ion-card-title>
                <ion-icon name="fitness-outline"></ion-icon>
                {{ rutina.nombre }}
              </ion-card-title>
              <div style="display: flex; gap: 8px; align-items: center;">
                @if (rutina.activa) {
                  <ion-chip color="success" style="margin: 0;">
                    <ion-icon name="checkmark-circle"></ion-icon>
                    <ion-label>Activa</ion-label>
                  </ion-chip>
                }
                @if (rutina.completado) {
                  <ion-chip color="primary" style="margin: 0;">
                    <ion-icon name="trophy-outline"></ion-icon>
                    <ion-label>Completada</ion-label>
                  </ion-chip>
                }
              </div>
            </div>
          </ion-card-header>
          
          <ion-card-content>
            <!-- Información de asignación -->
            <div class="info-asignacion" style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--ion-color-light);">
              <div style="display: flex; align-items: center; gap: 8px; color: var(--ion-color-medium); font-size: 13px;">
                <ion-icon name="calendar-outline"></ion-icon>
                <span>{{ formatearFecha(rutina.fechaCreacion) }}</span>
              </div>
            </div>

            <!-- Días programados -->
            @if (rutina.DiasSemana && rutina.DiasSemana.length > 0) {
              <div class="info-dias" style="margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                  <ion-icon name="calendar-outline" style="font-size: 16px; color: var(--ion-color-primary);"></ion-icon>
                  <span style="font-size: 12px; font-weight: 600; color: var(--ion-color-dark);">Días programados:</span>
                </div>
                <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                  @for (dia of rutina.DiasSemana; track $index) {
                    <ion-chip color="primary" style="margin: 0; font-size: 11px; height: 24px;">
                      {{ mapearDia(dia) }}
                    </ion-chip>
                  }
                </div>
              </div>
            }

            <!-- Estadísticas -->
            <div class="info-resumida">
              @if (rutina.duracion) {
                <div class="info-item">
                  <ion-icon name="time-outline"></ion-icon>
                  <span>{{ rutina.duracion }} min</span>
                </div>
              }
              
              @if (rutina.ejercicios && rutina.ejercicios.length > 0) {
                <div class="info-item">
                  <ion-icon name="fitness-outline"></ion-icon>
                  <span>{{ rutina.ejercicios.length }} ejercicios</span>
                </div>
              }

              @if (rutina.duracion) {
                <div class="info-item">
                  <ion-icon name="flame-outline"></ion-icon>
                  <span>~{{ calcularCaloriasEstimadas(rutina.duracion) }} kcal</span>
                </div>
              }
            </div>

            <div class="accion-rapida">
              <ion-button 
                fill="clear" 
                size="small"
                (click)="verDetalles($event, rutina)">
                Ver detalles completos
                <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      }
    </ion-list>
  </div>
</ion-content>

<!-- Modal de detalles -->
<ion-modal [isOpen]="modalAbierto()" (didDismiss)="cerrarModal()" class="rutina-modal">
  <ng-template>
    @if (rutinaSeleccionada()) {
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ rutinaSeleccionada()!.nombre }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <div class="modal-content">
          <!-- Información general -->
          <div class="modal-section">
            <h3>Información general</h3>
            <ion-list lines="none">
              @if (rutinaSeleccionada()!.duracion) {
                <ion-item>
                  <ion-icon name="time-outline" slot="start"></ion-icon>
                  <ion-label>
                    <h4>Duración</h4>
                    <p>{{ rutinaSeleccionada()!.duracion }} minutos</p>
                  </ion-label>
                </ion-item>
              }

              @if (ejerciciosCompletos().length > 0) {
                <ion-item>
                  <ion-icon name="fitness-outline" slot="start"></ion-icon>
                  <ion-label>
                    <h4>Ejercicios</h4>
                    <p>{{ ejerciciosCompletos().length }} ejercicios</p>
                  </ion-label>
                </ion-item>
              }

              @if (rutinaSeleccionada()!.duracion) {
                <ion-item>
                  <ion-icon name="flame-outline" slot="start"></ion-icon>
                  <ion-label>
                    <h4>Calorías estimadas</h4>
                    <p>~{{ calcularCaloriasEstimadas(rutinaSeleccionada()!.duracion) }} kcal</p>
                  </ion-label>
                </ion-item>
              }

              <ion-item>
                <ion-icon name="calendar-outline" slot="start"></ion-icon>
                <ion-label>
                  <h4>Fecha de creación</h4>
                  <p>{{ formatearFecha(rutinaSeleccionada()!.fechaCreacion) }}</p>
                </ion-label>
              </ion-item>

              <ion-item>
                <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                <ion-label>
                  <h4>Estado</h4>
                  <p>{{ rutinaSeleccionada()!.activa ? 'Activa' : 'Inactiva' }}</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </div>

          <!-- Días programados -->
          @if (rutinaSeleccionada()!.DiasSemana && rutinaSeleccionada()!.DiasSemana!.length > 0) {
            <div class="modal-section">
              <h3>
                <ion-icon name="calendar-outline"></ion-icon>
                Días programados
              </h3>
              <p>{{ formatearDiasSemana(rutinaSeleccionada()!.DiasSemana) }}</p>
            </div>
          }

          <!-- Lista de ejercicios -->
          @if (ejerciciosCompletos().length > 0) {
            <div class="modal-section">
              <h3>
                <ion-icon name="list-outline"></ion-icon>
                Ejercicios ({{ ejerciciosCompletos().length }})
              </h3>
              <ion-list>
                @for (ejercicio of ejerciciosCompletos(); track $index; let idx = $index) {
                  <ion-item lines="full" class="ejercicio-item">
                    <div class="ejercicio-numero" slot="start">{{ idx + 1 }}</div>
                    <ion-label>
                      <h4>{{ ejercicio.nombre || 'Ejercicio sin nombre' }}</h4>
                      @if (ejercicio.descripcion) {
                        <p class="ejercicio-descripcion">{{ ejercicio.descripcion }}</p>
                      }
                      <div class="ejercicio-detalles">
                        @if (ejercicio.series) {
                          <span><strong>{{ ejercicio.series }}</strong> series</span>
                        }
                        @if (ejercicio.repeticiones) {
                          @if (ejercicio.series) {
                            <span class="separador">•</span>
                          }
                          <span><strong>{{ ejercicio.repeticiones }}</strong> reps</span>
                        }
                        @if (ejercicio.peso) {
                          @if (ejercicio.series || ejercicio.repeticiones) {
                            <span class="separador">•</span>
                          }
                          <span><strong>{{ ejercicio.peso }}</strong> kg</span>
                        }
                        @if (ejercicio.serieSegundos) {
                          @if (ejercicio.series || ejercicio.repeticiones || ejercicio.peso) {
                            <span class="separador">•</span>
                          }
                          <span><strong>{{ ejercicio.serieSegundos }}</strong>s por serie</span>
                        }
                        @if (ejercicio.descansoSegundos) {
                          @if (ejercicio.series || ejercicio.repeticiones || ejercicio.peso || ejercicio.serieSegundos) {
                            <span class="separador">•</span>
                          }
                          <span>Descanso: <strong>{{ ejercicio.descansoSegundos }}s</strong></span>
                        }
                      </div>
                    </ion-label>
                  </ion-item>
                }
              </ion-list>
            </div>
          } @else {
            <div class="modal-section">
              <h3>
                <ion-icon name="list-outline"></ion-icon>
                Ejercicios
              </h3>
              <div style="text-align: center; padding: 24px; background: var(--ion-color-light); border-radius: 12px;">
                <ion-icon name="fitness-outline" style="font-size: 48px; color: var(--ion-color-medium); margin-bottom: 8px;"></ion-icon>
                <p style="margin: 0; color: var(--ion-color-medium);">Esta rutina no tiene ejercicios asignados</p>
              </div>
            </div>
          }

          <!-- Botones de acción -->
          <div class="modal-actions">
            @if (!cronometroActivo()) {
              <ion-button 
                expand="block" 
                color="primary"
                (click)="iniciarEntrenamiento(rutinaSeleccionada()!)"
                [disabled]="rutinaSeleccionada()!.completado">
                <ion-icon name="timer-outline" slot="start"></ion-icon>
                {{ rutinaSeleccionada()!.completado ? 'Completada' : 'Iniciar rutina' }}
              </ion-button>
              <p style="text-align: center; font-size: 12px; color: var(--ion-color-medium); margin: 8px 0 12px 0;">
                Se iniciará el cronómetro al comenzar
              </p>
            } @else if (rutinaEnCurso()?.id === rutinaSeleccionada()!.id) {
              <ion-button 
                expand="block" 
                color="warning"
                disabled>
                <ion-icon name="timer-outline" slot="start"></ion-icon>
                Rutina en curso
              </ion-button>
            } @else {
              <ion-button 
                expand="block" 
                color="medium"
                disabled>
                <ion-icon name="play-outline" slot="start"></ion-icon>
                Ya hay una rutina activa
              </ion-button>
            }
            
            <ion-button 
              expand="block" 
              fill="outline"
              [color]="rutinaSeleccionada()!.completado ? 'medium' : 'success'"
              (click)="marcarCompletado(rutinaSeleccionada()!)">
              <ion-icon [name]="rutinaSeleccionada()!.completado ? 'close-circle-outline' : 'checkmark-circle-outline'" slot="start"></ion-icon>
              {{ rutinaSeleccionada()!.completado ? 'Desmarcar como completada' : 'Marcar como completada' }}
            </ion-button>
          </div>
        </div>
      </ion-content>
    }
  </ng-template>
</ion-modal>
