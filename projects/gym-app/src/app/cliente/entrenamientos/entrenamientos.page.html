<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Mis Rutinas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Mis Rutinas</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="entrenamientos-container">
    <ion-list>
      @if (rutinas().length === 0) {
        <ion-card>
          <ion-card-content>
            <p style="text-align: center; padding: 20px; color: var(--ion-color-medium);">
              No tienes rutinas asignadas todavía.
            </p>
          </ion-card-content>
        </ion-card>
      }
      
      @for (rutina of rutinas(); track rutina.id) {
        <ion-card class="rutina-card" (click)="abrirDetalles(rutina)">
          <ion-card-header>
            <div class="card-header-content">
              <ion-card-title>
                <ion-icon name="fitness-outline"></ion-icon>
                {{ rutina.nombre }}
              </ion-card-title>
              @if (rutina.completado) {
                <ion-icon name="checkmark-circle" color="success" class="completado-icon"></ion-icon>
              }
            </div>
          </ion-card-header>
          
          <ion-card-content>
            <div class="info-resumida">
              <div class="info-item">
                <ion-icon name="time-outline"></ion-icon>
                <span>{{ rutina.duracion || 30 }} min</span>
              </div>
              
              <div class="info-item">
                <ion-icon name="fitness-outline"></ion-icon>
                <span>{{ rutina.ejercicios?.length || 0 }} ejercicios</span>
              </div>

              <div class="info-item">
                <ion-icon name="flame-outline"></ion-icon>
                <span>~{{ calcularCaloriasEstimadas(rutina.duracion) }} kcal</span>
              </div>
            </div>

            <div class="accion-rapida">
              <ion-button 
                fill="clear" 
                size="small"
                (click)="verDetalles($event, rutina)">
                Ver más
                <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      }
    </ion-list>
  </div>
</ion-content>

<!-- Modal de detalles -->
<ion-modal [isOpen]="modalAbierto()" (didDismiss)="cerrarModal()">
  <ng-template>
    @if (rutinaSeleccionada()) {
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ rutinaSeleccionada()!.nombre }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <div class="modal-content">
          <!-- Notas / Descripción -->
          @if (rutinaSeleccionada()!.notas) {
            <div class="modal-section">
              <h3>Descripción</h3>
              <p class="notas-text">{{ rutinaSeleccionada()!.notas }}</p>
            </div>
          }

          <!-- Información general -->
          <div class="modal-section">
            <h3>Información general</h3>
            <ion-list lines="none">
              <ion-item>
                <ion-icon name="time-outline" slot="start"></ion-icon>
                <ion-label>
                  <h4>Duración</h4>
                  <p>{{ rutinaSeleccionada()!.duracion || 30 }} minutos</p>
                </ion-label>
              </ion-item>

              <ion-item>
                <ion-icon name="fitness-outline" slot="start"></ion-icon>
                <ion-label>
                  <h4>Ejercicios</h4>
                  <p>{{ rutinaSeleccionada()!.ejercicios?.length || 0 }} ejercicios</p>
                </ion-label>
              </ion-item>

              <ion-item>
                <ion-icon name="flame-outline" slot="start"></ion-icon>
                <ion-label>
                  <h4>Calorías estimadas</h4>
                  <p>~{{ calcularCaloriasEstimadas(rutinaSeleccionada()!.duracion) }} kcal</p>
                </ion-label>
              </ion-item>

              <ion-item>
                <ion-icon name="calendar-outline" slot="start"></ion-icon>
                <ion-label>
                  <h4>Fecha de asignación</h4>
                  <p>{{ formatearFecha(rutinaSeleccionada()!.fechaAsignacion) }}</p>
                </ion-label>
              </ion-item>

              <ion-item>
                <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                <ion-label>
                  <h4>Estado</h4>
                  <p>{{ rutinaSeleccionada()!.activa ? 'Activa' : 'Inactiva' }}</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </div>

          <!-- Días programados -->
          @if (rutinaSeleccionada()!.DiasSemana && rutinaSeleccionada()!.DiasSemana!.length > 0) {
            <div class="modal-section">
              <h3>
                <ion-icon name="calendar-outline"></ion-icon>
                Días programados
              </h3>
              <p>{{ formatearDiasSemana(rutinaSeleccionada()!.DiasSemana) }}</p>
            </div>
          }

          <!-- Lista de ejercicios -->
          @if (rutinaSeleccionada()!.ejercicios && rutinaSeleccionada()!.ejercicios!.length > 0) {
            <div class="modal-section">
              <h3>
                <ion-icon name="list-outline"></ion-icon>
                Ejercicios ({{ rutinaSeleccionada()!.ejercicios!.length }})
              </h3>
              <ion-list>
                @for (ejercicio of rutinaSeleccionada()!.ejercicios; track ejercicio.id; let idx = $index) {
                  <ion-item lines="full" class="ejercicio-item">
                    <div class="ejercicio-numero" slot="start">{{ idx + 1 }}</div>
                    <ion-label>
                      <h4>{{ ejercicio.nombre }}</h4>
                      @if (ejercicio.descripcion) {
                        <p class="ejercicio-descripcion">{{ ejercicio.descripcion }}</p>
                      }
                      <div class="ejercicio-detalles">
                        <span><strong>{{ ejercicio.series }}</strong> series</span>
                        <span class="separador">•</span>
                        <span><strong>{{ ejercicio.repeticiones }}</strong> reps</span>
                        @if (ejercicio.peso) {
                          <span class="separador">•</span>
                          <span><strong>{{ ejercicio.peso }}</strong> kg</span>
                        }
                        @if (ejercicio.descansoSegundos) {
                          <span class="separador">•</span>
                          <span>Descanso: <strong>{{ ejercicio.descansoSegundos }}s</strong></span>
                        }
                      </div>
                    </ion-label>
                  </ion-item>
                }
              </ion-list>
            </div>
          }

          <!-- Botones de acción -->
          <div class="modal-actions">
            <ion-button 
              expand="block" 
              color="primary"
              (click)="iniciarEntrenamiento(rutinaSeleccionada()!)"
              [disabled]="rutinaSeleccionada()!.completado">
              <ion-icon name="play-outline" slot="start"></ion-icon>
              {{ rutinaSeleccionada()!.completado ? 'Completada' : 'Iniciar rutina' }}
            </ion-button>
            
            <ion-button 
              expand="block" 
              fill="outline"
              [color]="rutinaSeleccionada()!.completado ? 'medium' : 'success'"
              (click)="marcarCompletado(rutinaSeleccionada()!)">
              <ion-icon [name]="rutinaSeleccionada()!.completado ? 'close-circle-outline' : 'checkmark-circle-outline'" slot="start"></ion-icon>
              {{ rutinaSeleccionada()!.completado ? 'Desmarcar como completada' : 'Marcar como completada' }}
            </ion-button>
          </div>
        </div>
      </ion-content>
    }
  </ng-template>
</ion-modal>
